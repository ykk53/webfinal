<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建筑详情 - 中国古代建筑</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 建筑描述基础样式 */
        .architecture-description {
            padding: 30px;
            line-height: 1.8;
            font-size: 1.05em;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* 章节导航栏样式 - 缩小优化版 */
        .toc-container {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 180px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            background: var(--surface-strong);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 10px 8px;
            z-index: 100;
        }

        .toc-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            color: var(--brand);
            text-align: center;
        }

        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .toc-item {
            margin: 4px 0;
        }

        .toc-link {
            text-decoration: none;
            color: var(--ink);
            display: block;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .toc-link:hover {
            background: rgba(178, 27, 27, 0.1);
            color: var(--brand);
        }

        .toc-link.active {
            background: var(--brand);
            color: white;
            font-weight: 500;
        }
   
/* 图片容器核心样式 */
.architecture-description .image-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 1.5em auto;
    max-width: 100%;
    text-align: center;
}

/* 单张图片的容器样式（不在画廊中时） */
.architecture-description .image-container:not(.image-gallery > .image-container) {
    width: 100%;
}

/* 确保图片在容器内正确显示 */
.architecture-description .description-image {
    max-height: 400px;
    max-width: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: var(--radius);
}

/* 单张图片样式 */
.architecture-description .image-container:not(.image-gallery > .image-container) .description-image {
    max-width: 100%;
    box-shadow: var(--shadow);
    margin: 0 auto; /* 确保居中 */
}

.architecture-description .image-gallery {
    display: flex;
    justify-content: center;
   
    gap: 16px;
    margin: 1.5em 0;
    width: 100%;
    box-sizing: border-box;
    align-items: stretch; /* 强制所有子容器高度一致 */
    overflow-x: auto;
    padding-bottom: 10px;
}
/* 画廊中的图片容器（适配3张/2张图片） */
.architecture-description .image-gallery .image-container {
    flex: 1;
    min-width: 180px; /* 最小宽度，小屏也能正常显示 */
    max-width: none;
    margin: 0;
      width: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
     flex: none;
}

/* 统一图片显示区域的尺寸（关键：固定容器高度） */
.architecture-description .image-gallery .image-container .description-image {
    width: 100%;
    height: 350px; /* 固定显示高度，所有图片统一 */
    object-fit: cover; /* 按比例裁剪，填充容器（不拉伸变形） */
    /* 若不想裁剪，改用 object-fit: contain; 但会留白，根据需求选 */
    border-radius: var(--radius);
}

/* 图片标题居中，避免标题错位 */
.architecture-description .image-gallery .image-caption {
    margin-top: 8px;
    font-size: 14px;
    text-align: center;
    width: 100%;
}

        /* 文本内容样式 */
        .architecture-description p {
            margin-bottom: 1.5em;
            text-align: left;
            text-indent: 2em;
        }

        .architecture-description p:last-child {
            margin-bottom: 0;
        }

        .architecture-description h1,
        .architecture-description h2,
        .architecture-description h3 {
            color: var(--brand);
            margin: 1.5em 0 0.8em 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3em;
        }

        .architecture-description h1 { font-size: 1.8em; }
        .architecture-description h2 { font-size: 1.5em; }
        .architecture-description h3 { font-size: 1.3em; }

        .architecture-description ul,
        .architecture-description ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .architecture-description li {
            margin-bottom: 0.5em;
        }

        .architecture-description strong {
            color: var(--brand-2);
            font-weight: 600;
        }

        .architecture-description em {
            font-style: italic;
            color: var(--muted);
        }

        .architecture-description code {
            background: rgba(178, 27, 27, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .architecture-description a {
            color: var(--brand);
            text-decoration: underline;
        }

        .architecture-description a:hover {
            color: var(--brand-2);
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .toc-container {
                width: 160px;
            }
        }

        @media (max-width: 992px) {
            .toc-container {
                position: static;
                width: 100%;
                max-height: none;
                margin: 15px 0;
                padding: 10px 15px;
            }
            .toc-link {
                font-size: 13px;
            }
            /* 移动端画廊图片占比调整 */
            .architecture-description .image-gallery .image-container {
                max-width: 100%; /* 移动端单张图片占满宽度 */
            }
            /* 移动端单图宽度调整 */
            .architecture-description img:not(.image-gallery img) {
                max-width: 95%;
            }
        }

    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div class="navbar">
        <div class="navbar-brand">
            中国古代建筑
        </div>
        <div class="navbar-menu">
            <a href="index.html"><i class="fas fa-home"></i> 首页</a>
            <a href="list.html"><i class="fas fa-list"></i> 建筑列表</a>
            <a href="quiz.html"><i class="fas fa-question-circle"></i> 问答</a>
            <a href="login.html"><i class="fas fa-sign-in-alt"></i> 登录</a>
            <a href="user-center.html"><i class="fas fa-user"></i> 个人中心</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出</a>
        </div>
    </div>

    <div class="container">
        <!-- 章节导航容器 -->
        <div class="toc-container" id="tocContainer">
            <div class="toc-title"><i class="fas fa-list"></i> 章节导航</div>
            <ul class="toc-list" id="tocList">
                <!-- 动态生成章节列表 -->
            </ul>
        </div>

        <div id="detail">
            <p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> 加载中...</p>
        </div>
        <div style="margin-top: 20px;">
            <a href="list.html" class="btn" style="display: inline-flex; align-items: center; gap: 8px;"><i class="fas fa-arrow-left"></i> 返回列表</a>
        </div>
    </div>

    <div class="footer"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/markdown-parser.js"></script>
    <script>
        // 获取URL中的建筑ID
        const id = new URLSearchParams(window.location.search).get('id');
        
        // 生成章节导航（含长标题截断）
        function generateTableOfContents() {
            const content = document.getElementById('description-content');
            const tocList = document.getElementById('tocList');
            const tocContainer = document.getElementById('tocContainer');
            
            if (!content || !tocList || !tocContainer) return;
            
            // 获取所有标题元素
            const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
            
            // 无标题时隐藏导航
            if (headings.length === 0) {
                tocContainer.style.display = 'none';
                return;
            }
            
            tocList.innerHTML = '';
            
            // 为每个标题生成导航项
            headings.forEach((heading, index) => {
                const headingId = `heading-${index}`;
                heading.id = headingId;
                
                // 处理标题文本：截断过长标题（最多15个字符）
                const fullTitle = heading.textContent.trim();
                const shortTitle = fullTitle.length > 15 
                    ? fullTitle.substring(0, 15) + '...' 
                    : fullTitle;
                
                const li = document.createElement('li');
                li.className = `toc-item toc-level-${heading.tagName.toLowerCase()}`;
                
                const a = document.createElement('a');
                a.href = `#${headingId}`;
                a.className = 'toc-link';
                a.textContent = shortTitle; // 显示截断后的标题
                a.title = fullTitle; // 完整标题存入title，hover时显示
                
                // 点击导航项平滑滚动（优化：避开顶部导航栏遮挡）
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    // 获取顶部导航栏实际高度（兼容无导航栏的情况）
                    const navbar = document.querySelector('.navbar');
                    const navbarHeight = navbar ? navbar.offsetHeight : 70;
                    // 计算目标滚动位置：标题顶部 - 导航栏高度 - 20px额外间距
                    const targetRect = heading.getBoundingClientRect();
                    const targetTop = window.pageYOffset + targetRect.top - navbarHeight - 20;
                    // 平滑滚动到目标位置
                    window.scrollTo({
                        top: targetTop,
                        behavior: 'smooth'
                    });
                });
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
            
            // 监听滚动高亮当前章节
            window.addEventListener('scroll', highlightCurrentHeading);
        }

        // 高亮当前阅读的章节
        function highlightCurrentHeading() {
            const headings = document.querySelectorAll('#description-content h1, #description-content h2, #description-content h3, #description-content h4, #description-content h5, #description-content h6');
            const tocLinks = document.querySelectorAll('.toc-link');
            let currentHeadingIndex = -1;
            
            // 找到当前可视区域内的第一个标题（优化：兼容导航栏高度）
            const navbar = document.querySelector('.navbar');
            const navbarHeight = navbar ? navbar.offsetHeight : 70;
            headings.forEach((heading, index) => {
                const rect = heading.getBoundingClientRect();
                // 标题顶部进入「导航栏下方」可视区域即判定为当前章节
                if (rect.top <= navbarHeight + 20 && rect.bottom >= 0) {
                    currentHeadingIndex = index;
                }
            });
            
            // 更新导航高亮状态
            tocLinks.forEach((link, index) => {
                if (index === currentHeadingIndex) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        // 加载建筑详情
        $.ajax({
            url: 'api/get-architecture-detail.php?id=' + id,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                if(data.success && data.data) {
                    const item = data.data;
                    const imageUrl = item.image && item.image.trim() !== '' ? item.image : 'https://placehold.co/800x500/8f1414/ffffff?text=中国古建';
                    
                    let html = `
                        <div class="card" style="padding: 0; overflow: hidden;">
                            <div style="height: 400px; width: 100%; overflow: hidden; position: relative;">
                             <img src="${imageUrl}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.onerror=null;this.src='https://placehold.co/800x500/e0e0e0/333333?text=暂无图片';">   
                                <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 40px 30px 20px 30px; color: white;">
                                    <h1 style="color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 0;">${item.name}</h1>
                                </div>
                            </div>
                            
                            <div style="padding: 0 30px; margin-top: 30px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; color: #666;">
                                    <div><i class="fas fa-tag" style="color: var(--brand); margin-right: 8px;"></i> ${item.type || '未分类'}</div>
                                    <div><i class="fas fa-landmark" style="color: var(--brand); margin-right: 8px;"></i> ${item.dynasty || '未知朝代'}</div>
                                    <div><i class="fas fa-map-marker-alt" style="color: var(--brand); margin-right: 8px;"></i> ${item.location || '未知地点'}</div>
                                </div>
                                
                                <h2 style="border-bottom: 2px solid var(--brand); padding-bottom: 10px; margin-bottom: 20px;">建筑简介</h2>
                                <div class="architecture-description" id="description-content">
                                    ${item.description || '<p>暂无详细介绍</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                    $('#detail').html(html);
                    
                    // 渲染Markdown并生成导航
                    if (item.description) {
                        renderRichText('description-content', item.description);
                        setTimeout(generateTableOfContents, 100); // 延迟确保DOM更新
                    }
                } else {
                    $('#detail').html('<div class="error">未找到该建筑信息</div>');
                }
            },
            error: function() {
                $('#detail').html('<div class="error">加载失败，请稍后重试</div>');
            }
        });
    </script>
</body>