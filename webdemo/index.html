<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国古代建筑 - 首页</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/markdown-parser.js"></script>
    <style>
        /* 分类浏览样式 */
        .category-browse {
            margin: 40px 0;
        }

        .categories-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
            align-items: start;
        }

        .category-item {
            background: var(--surface-strong);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .category-item:hover {
            transform: translateY(-5px);
        }

        .category-header {
            padding: 15px;
            background: var(--brand);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .category-header h3 {
            color: white;
            margin: 0;
        }

        .category-header i {
            font-size: 1.5em;
            color: white;
        }

        .category-carousel {
            position: relative;
            height: 0;
            overflow: hidden;
            transition: height 0.5s ease;
        }

        .category-item:hover .category-carousel {
            height: 220px;
        }

        .carousel-wrapper {
            display: flex;
            padding: 15px;
            gap: 10px;
            overflow-x: hidden; /* 隐藏超出部分 */
            scroll-behavior: smooth;
            height: 100%;
            align-items: center;
            justify-content: center; /* 水平居中 */
            text-align: center;      /* 确保内容文本居中 */
            position: relative;
        }

        .carousel-slide {
            min-width: 100%; /* 每个幻灯片占满容器宽度 */
            transition: transform 0.5s ease;
            display: flex;
            justify-content: center;
        }

        .carousel-wrapper img {
            width: 180px;
            height: 140px;
            object-fit: cover;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .carousel-wrapper img:hover {
            transform: scale(1.05);
        }

        .carousel-control {
            position: absolute;
            top: 50%;
            background: rgba(255,255,255,0.8);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: 0.7;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .carousel-control:hover {
            opacity: 1;
        }

        .carousel-control.prev {
            left: 10px;
            transform: translateY(-20%);
        }

        .carousel-control.next {
            right: 10px;
            transform: translateY(-20%);
        }

        /* 隐藏滚动条但保留功能 */
        .carousel-wrapper::-webkit-scrollbar {
            display: none;
        }
        .carousel-wrapper {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 轮播项内部元素居中 */
        .carousel-wrapper > a {
            margin: 0 auto; /* 确保每个轮播项自身也居中 */
        }

        /* 精选建筑区域 */
        .featured-buildings {
            margin: 40px 0;
        }
        
        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="page-index">
    <!-- 导航栏 -->
    <div class="navbar">
        <div class="navbar-brand">
            中国古代建筑
        </div>
        <div class="navbar-menu">
            <a href="index.html" class="active"><i class="fas fa-home"></i> 首页</a>
            <a href="list.html"><i class="fas fa-list"></i> 建筑列表</a>
            <a href="quiz.html"><i class="fas fa-question-circle"></i> 问答</a>
            <a href="login.html"><i class="fas fa-sign-in-alt"></i> 登录</a>
            <a href="user-center.html"><i class="fas fa-user"></i> 个人中心</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出</a>
        </div>
    </div>

    <div class="container">
        <!-- Hero Banner -->
        <div class="hero">
            <div class="hero-text-swap">
                <div class="text-zh">
                    <h1>探索中国古代建筑的魅力</h1>
                    <p>穿越千年时光，领略传统建筑艺术的精髓与智慧</p>
                </div>
                <div class="text-en">
                    <h1>Explore the Charm of Ancient Chinese Architecture</h1>
                    <p>Travel through a thousand years to appreciate the essence and wisdom of traditional architectural art</p>
                </div>
            </div>
        </div>

        <!-- 分类浏览区域 -->
        <div class="category-browse">
            <h2><i class="fas fa-th-large"></i> 按类型浏览</h2>
            <div class="categories-container">
                <!-- 民宿类别 -->
                <div class="category-item" data-type="民宿">
                    <div class="category-header">
                        <i class="fas fa-home"></i>
                        <h3>民宿</h3>
                    </div>
                    <div class="category-carousel">
                        <div class="carousel-wrapper"></div>
                        <button class="carousel-control prev"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-control next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- 官府类别 -->
                <div class="category-item" data-type="官府">
                    <div class="category-header">
                        <i class="fas fa-building"></i>
                        <h3>官府</h3>
                    </div>
                    <div class="category-carousel">
                        <div class="carousel-wrapper"></div>
                        <button class="carousel-control prev"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-control next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- 皇宫类别 -->
                <div class="category-item" data-type="皇宫">
                    <div class="category-header">
                        <i class="fas fa-university"></i>
                        <h3>皇宫</h3>
                    </div>
                    <div class="category-carousel">
                        <div class="carousel-wrapper"></div>
                        <button class="carousel-control prev"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-control next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- 桥梁类别 -->
                <div class="category-item" data-type="桥梁">
                    <div class="category-header">
                        <i class="fas fa-bridge"></i>
                        <h3>桥梁</h3>
                    </div>
                    <div class="category-carousel">
                        <div class="carousel-wrapper"></div>
                        <button class="carousel-control prev"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-control next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 精选建筑 -->
        <div class="featured-buildings">
            <h2><i class="fas fa-star"></i> 精选建筑</h2>
            <div class="buildings-grid" id="featuredBuildings">
                <!-- 精选建筑将通过JS动态加载 -->
                <p style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--muted);">
                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                </p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>©中国古代建筑文化网 | 探索千年建筑之美</p>
    </div>

    <script>
        // 通用JavaScript函数
        // 检查用户登录状态
        function checkLoginStatus() {
            $.ajax({
                url: 'api/check-login.php',
                method: 'GET',
                success: function(response) {
                    if (response && response.success && response.logged_in) {
                        setNavbarAuthState(true, response.is_admin);
                    } else {
                        setNavbarAuthState(false, false);
                    }
                },
                error: function() {
                    setNavbarAuthState(false, false);
                }
            });
        }

        function setNavbarAuthState(loggedIn, isAdmin) {
            const loginLinks = $('.navbar a[href="login.html"]');
            const logoutLink = $('#logoutBtn');
            const userCenterLink = $('.navbar a[href="user-center.html"]');
            
            // 检查是否已存在管理后台链接
            let adminLink = $('#adminLink');

            if (loggedIn) {
                loginLinks.hide();
                logoutLink.show();
                userCenterLink.show();
                
                if (isAdmin) {
                    if (adminLink.length === 0) {
                        // 在退出按钮前插入管理后台链接
                        $('<a href="manager.html" id="adminLink"><i class="fas fa-tachometer-alt"></i> 管理后台</a>').insertBefore(logoutLink);
                    }
                } else {
                    if (adminLink.length > 0) adminLink.remove();
                }
            } else {
                loginLinks.show();
                logoutLink.hide();
                userCenterLink.hide();
                if (adminLink.length > 0) adminLink.remove();
            }
        }

        // 退出登录
        function logout() {
            $.ajax({
                url: 'api/logout.php',
                method: 'POST',
                success: function() {
                    window.location.href = 'index.html';
                }
            });
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 安全地渲染富文本内容（用于详情页）
        function renderRichText(elementId, text) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (!text || text.trim() === '') {
                element.innerHTML = '<p>暂无详细介绍</p>';
                return;
            }
            
            // 使用Markdown解析器
            element.innerHTML = MarkdownParser.parse(text);
        }

        // 渲染建筑卡片
        function renderArchitectureCard(item) {
            // 处理图片路径，如果没有图片则使用占位图
            const imageUrl = item.image && item.image.trim() !== '' ? item.image : 'https://placehold.co/600x400/8f1414/ffffff?text=中国古建';

            // 使用Markdown解析器生成纯文本摘要
            const desc = item.description ? 
                MarkdownParser.generateExcerpt(item.description, 80) : 
                '暂无描述';
            
            const dynasty = item.dynasty || '未知朝代';
            const location = item.location || '未知地点';

            return `
                <div class="card">
                        <img src="${imageUrl}" alt="${item.name}" class="card-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e0e0e0/333333?text=暂无图片';">
                    <div class="card-content">
                        <h3>${item.name}</h3>
                        <p style="font-size: 0.9em; color: var(--brand); margin-bottom: 8px;">
                            <i class="fas fa-tag"></i> ${item.type} &nbsp; 
                            <i class="fas fa-landmark"></i> ${dynasty}
                        </p>
                        <p style="color: var(--muted); font-size: 0.9em; flex-grow: 1;">${desc}</p>
                        <a href="detail.html?id=${item.id}" class="btn-link">
                            查看详情 <i class="fas fa-arrow-right" style="font-size: 0.8em; margin-left: 4px;"></i>
                        </a>
                    </div>
                </div>
            `;
        }

        // 加载分类建筑图片
        function loadCategoryBuildings() {
            // 所有建筑类型
            const categories = ['民宿', '官府', '皇宫', '桥梁'];
            
            categories.forEach(category => {
                // 使用与精选建筑相同的API获取方式
                $.ajax({
                    url: `api/get-architectures.php?type=${encodeURIComponent(category)}`,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        if (data.success && data.data.length > 0) {
                            const carousel = $(`.category-item[data-type="${category}"] .carousel-wrapper`);
                            let html = '';
                            
                            data.data.forEach(item => {
                                // 与现有图片处理方式保持一致
                                const imageUrl = item.image && item.image.trim() !== '' 
                                    ? item.image 
                                    : 'https://placehold.co/600x400/8f1414/ffffff?text=中国古建';
                                
                                html += `
                                    <div class="carousel-slide">
                                        <a href="detail.html?id=${item.id}" title="${item.name}">
                                            <img src="${imageUrl}" alt="${item.name}" 
                                                 onerror="this.onerror=null;this.src='https://placehold.co/600x400/e0e0e0/333333?text=暂无图片';">
                                        </a>
                                    </div>
                                `;
                            });
                            
                            carousel.html(html);
                            // 初始化轮播状态
                            carousel.data('currentSlide', 0);
                            // 初始化只显示第一张
                            carousel.find('.carousel-slide').each(function(index) {
                                $(this).css('display', index === 0 ? 'flex' : 'none');
                            });
                        } else {
                            $(`.category-item[data-type="${category}"] .carousel-wrapper`).html(
                                '<p style="width: 100%; text-align: center; color: var(--muted);">暂无该类别建筑</p>'
                            );
                        }
                    },
                    error: function() {
                        $(`.category-item[data-type="${category}"] .carousel-wrapper`).html(
                            '<p style="width: 100%; text-align: center; color: var(--danger);">加载失败</p>'
                        );
                    }
                });
            });
            
            // 轮播控制
            initCarouselControls();
            // 初始化自动轮播
            initAutoCarousel();
        }

        // 初始化轮播控制按钮
        function initCarouselControls() {
            $('.carousel-control.prev').click(function() {
                const wrapper = $(this).siblings('.carousel-wrapper');
                const slides = wrapper.find('.carousel-slide');
                if (slides.length <= 1) return;
                
                let currentSlide = wrapper.data('currentSlide') || 0;
                currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                wrapper.data('currentSlide', currentSlide);
                
                // 只显示当前幻灯片，隐藏其他
                slides.each(function(index) {
                    $(this).css('display', index === currentSlide ? 'flex' : 'none');
                });
            });
            
            $('.carousel-control.next').click(function() {
                const wrapper = $(this).siblings('.carousel-wrapper');
                const slides = wrapper.find('.carousel-slide');
                if (slides.length <= 1) return;
                
                let currentSlide = wrapper.data('currentSlide') || 0;
                currentSlide = (currentSlide + 1) % slides.length;
                wrapper.data('currentSlide', currentSlide);
                
                // 只显示当前幻灯片，隐藏其他
                slides.each(function(index) {
                    $(this).css('display', index === currentSlide ? 'flex' : 'none');
                });
            });
        }

        // 初始化自动轮播
        function initAutoCarousel() {
            // 为每个分类轮播添加鼠标悬停自动轮播
            $('.category-item').each(function() {
                let autoPlayTimer = null;
                const $carouselItem = $(this);
                const $carouselWrapper = $carouselItem.find('.carousel-wrapper');
                const $carouselContainer = $carouselItem.find('.category-carousel');
                
                // 鼠标悬停时启动自动轮播
                $carouselItem.hover(
                    // 鼠标进入
                    function() {
                        // 先清除原有定时器
                        if (autoPlayTimer) clearInterval(autoPlayTimer);
                        
                        // 启动自动轮播（每2秒切换一次）
                        autoPlayTimer = setInterval(function() {
                            const slides = $carouselWrapper.find('.carousel-slide');
                            if (slides.length <= 1) return;
                            
                            let currentSlide = $carouselWrapper.data('currentSlide') || 0;
                            currentSlide = (currentSlide + 1) % slides.length;
                            $carouselWrapper.data('currentSlide', currentSlide);
                            
                            // 只显示当前幻灯片，隐藏其他
                            slides.each(function(index) {
                                $(this).css('display', index === currentSlide ? 'flex' : 'none');
                            });
                        }, 2000);
                    },
                    // 鼠标离开
                    function() {
                        // 清除定时器，停止自动轮播
                        if (autoPlayTimer) {
                            clearInterval(autoPlayTimer);
                            autoPlayTimer = null;
                        }
                    }
                );
            });
        }

        // 加载精选建筑
        function loadFeaturedBuildings() {
            $.ajax({
                url: 'api/get-architectures.php?limit=6',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    const container = $('#featuredBuildings');
                    
                    if (data.success && data.data.length > 0) {
                        let html = '';
                        data.data.forEach(item => {
                            html += renderArchitectureCard(item);
                        });
                        container.html(html);
                    } else {
                        container.html('<p style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--muted);">暂无精选建筑</p>');
                    }
                },
                error: function() {
                    $('#featuredBuildings').html('<p style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--danger);">加载失败，请刷新页面重试</p>');
                }
            });
        }

        // 页面加载时执行
        $(document).ready(function() {
            // 绑定退出事件
            $(document).off('click', '#logoutBtn').on('click', '#logoutBtn', function(e) {
                e.preventDefault();
                logout();
            });

            // 检查登录状态
            setNavbarAuthState(false);
            checkLoginStatus();

            // 加载分类建筑
            loadCategoryBuildings();

            // 加载精选建筑
            loadFeaturedBuildings();
        });
    </script>
</body>
</html>