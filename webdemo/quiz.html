<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>çŸ¥è¯†é—®ç­” - ä¸­å›½å¤ä»£å»ºç­‘</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            ä¸­å›½å¤ä»£å»ºç­‘
        </div>
        <div class="navbar-menu">
            <a href="index.html"><i class="fas fa-home"></i> é¦–é¡µ</a>
            <a href="list.html"><i class="fas fa-list"></i> å»ºç­‘åˆ—è¡¨</a>
            <a href="quiz.html" class="active"><i class="fas fa-question-circle"></i> é—®ç­”</a>
            <a href="login.html"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
            <a href="user-center.html"><i class="fas fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <h1><i class="fas fa-graduation-cap"></i> çŸ¥è¯†é—®ç­”</h1>
        
        <div class="card" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <span style="display: block; font-size: 0.9em; color: var(--muted);">ç­”å¯¹</span>
                    <strong id="correct" style="font-size: 1.5em; color: #155724;">0</strong>
                </div>
                <div style="width: 1px; background: var(--border);"></div>
                <div>
                    <span style="display: block; font-size: 0.9em; color: var(--muted);">ç­”é”™</span>
                    <strong id="wrong" style="font-size: 1.5em; color: #721c24;">0</strong>
                </div>
                <div style="width: 1px; background: var(--border);"></div>
                <div>
                    <span style="display: block; font-size: 0.9em; color: var(--muted);">è¿›åº¦</span>
                    <strong id="progress" style="font-size: 1.5em; color: var(--brand);">0/7</strong>
                </div>
            </div>
        </div>

        <div class="card" id="quiz" style="min-height: 200px; padding: 30px; display: flex; flex-direction: column; justify-content: center;">
            <p style="text-align: center; color: var(--muted);"><i class="fas fa-spinner fa-spin"></i> é¢˜ç›®åŠ è½½ä¸­...</p>
        </div>
        
        <button class="btn" id="nextBtn" onclick="nextQuestion()" style="width: 100%; margin-top: 20px; font-size: 1.1em; display: none;">
            ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>
        </button>

        <!-- ç§¯åˆ†æ’è¡Œæ¦œ -->
        <div class="card" style="margin-top: 30px;">
            <h3 style="margin-top: 0; color: var(--brand);"><i class="fas fa-trophy"></i> ç§¯åˆ†æ’è¡Œæ¦œ</h3>
            <div id="rankingsList" style="max-height: 300px; overflow-y: auto;">
                <p style="text-align: center; color: var(--muted);"><i class="fas fa-spinner fa-spin"></i> æ’è¡Œæ¦œåŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <div class="footer">
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/main.js"></script>
    <script>
    let quizzes = [];
    let currentQuizIndex = 0;
    let correct = 0, wrong = 0;
    let isAnswered = false;

    function loadQuiz() {
        $('#quiz').html('<p style="text-align: center; color: var(--muted); padding: 40px;"><i class="fas fa-spinner fa-spin"></i> é¢˜ç›®åŠ è½½ä¸­...</p>');
        
        $.ajax({
            url: 'api/get-quiz.php',
            method: 'GET',
            success: function(data) {
                if (!data.success) {
                    $('#quiz').html(`<div class="error"><i class="fas fa-exclamation-circle"></i> ${data.message || 'åŠ è½½å¤±è´¥'}</div>`);
                    return;
                }
                
                quizzes = data.data;
                if (quizzes.length === 0) {
                    $('#quiz').html('<div class="error"><i class="fas fa-exclamation-circle"></i> æš‚æ— é¢˜ç›®</div>');
                    return;
                }
                
                currentQuizIndex = 0;
                correct = 0;
                wrong = 0;
                updateStats();
                renderQuiz(currentQuizIndex);
            },
            error: function() {
                $('#quiz').html('<div class="error"><i class="fas fa-exclamation-triangle"></i> åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•</div>');
            }
        });
        
        // åŠ è½½æ’è¡Œæ¦œ
        loadRankings();
    }

    function renderQuiz(index) {
        if (index >= quizzes.length) {
            showFinalResult();
            return;
        }
        
        isAnswered = false;
        $('#nextBtn').hide();
        const quiz = quizzes[index];
        let html = `<h3 style="margin-bottom: 20px; color: var(--brand);"><i class="fas fa-question-circle"></i> ${quiz.question}</h3>`;
        html += '<ul class="list" style="border: none;">';
        
        const options = [
            { key: 'A', val: quiz.option_a },
            { key: 'B', val: quiz.option_b },
            { key: 'C', val: quiz.option_c },
            { key: 'D', val: quiz.option_d }
        ];
        
        options.forEach(opt => {
            html += `
                <li style="padding: 12px; border: 1px solid var(--border); margin-bottom: 14px; border-radius: 10px; cursor: pointer; transition: all 0.2s; background: rgba(255, 255, 255, 0.92);" 
                    onmouseover="this.style.borderColor='rgba(178, 27, 27, 0.55)'; this.style.boxShadow='var(--ring)'; this.style.backgroundColor='rgba(255, 255, 255, 0.98)'" 
                    onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'; this.style.backgroundColor='rgba(255, 255, 255, 0.92)'">
                    <label style="display: flex; align-items: center; cursor: pointer; margin: 0; width: 100%;">
                        <input type="radio" name="ans" value="${opt.key}" style="margin-right: 10px; width: auto;" onclick="if(!isAnswered) checkAnswer('${opt.key}')">
                        <span style="font-weight: 500;">${opt.key}.</span>&nbsp;${opt.val}
                    </label>
                </li>`;
        });
        
        html += '</ul>';
        html += '<div id="result" style="margin-top: 20px;"></div>';
        $('#quiz').html(html);
    }

   function checkAnswer(ans) {
    isAnswered = true;
    const quiz = quizzes[currentQuizIndex];
    const isLast = currentQuizIndex === quizzes.length - 1;
    
    // ç¦ç”¨æ‰€æœ‰é€‰é¡¹é˜²æ­¢é‡å¤ç‚¹å‡»
    $('input[name="ans"]').prop('disabled', true);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $('#result').html('<p style="text-align: center; color: var(--muted);"><i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...</p>');
    
    // æäº¤ç­”æ¡ˆåˆ°åç«¯
    $.ajax({
        url: 'api/submit-quiz.php',
        method: 'POST',
        data: {
            quiz_id: quiz.id,
            user_answer: ans,
            is_last: isLast ? 1 : 0
        },
        success: function(response) {
            if (response.success) {
                const isCorrect = response.is_correct;
                if (isCorrect) {
                    correct++;
                    $('#result').html('<div class="success"><i class="fas fa-check-circle"></i> å›ç­”æ­£ç¡®ï¼</div>');
                } else {
                    wrong++;
                    $('#result').html(`<div class="error"><i class="fas fa-times-circle"></i> å›ç­”é”™è¯¯ï¼<br>æ­£ç¡®ç­”æ¡ˆï¼š<strong>${quiz.correct_answer}</strong><br><small>${quiz.explanation || ''}</small></div>`);
                }
                updateStats();
                $('#nextBtn').show();
            } else {
                $('#result').html('<div class="error"><i class="fas fa-exclamation-triangle"></i> æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•</div>');
                $('input[name="ans"]').prop('disabled', false);
                isAnswered = false;
            }
        },
        error: function() {
            $('#result').html('<div class="error"><i class="fas fa-exclamation-triangle"></i> ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</div>');
            $('input[name="ans"]').prop('disabled', false);
            isAnswered = false;
        }
    });
}

    function nextQuestion() {
        currentQuizIndex++;
        renderQuiz(currentQuizIndex);
    }

    function showFinalResult() {
        $('#quiz').html(`
            <div style="text-align: center; padding: 20px;">
                <h3><i class="fas fa-certificate" style="color: #ffc107;"></i> ç­”é¢˜å®Œæˆï¼</h3>
                <p style="font-size: 1.2em; margin: 20px 0;">æ‚¨å…±ç­”å¯¹ <strong style="color: #155724;">${correct}</strong> é¢˜ï¼Œè·å¾— <strong style="color: var(--brand);">${correct}</strong> ç§¯åˆ†</p>
                <p>æ¯å¤©å¯å‚ä¸ä¸€æ¬¡ç­”é¢˜ï¼Œæ˜å¤©å†æ¥æŒ‘æˆ˜å§ï¼</p>
            </div>
        `);
        $('#nextBtn').hide();
    }

    function updateStats() {
        $('#correct').text(correct);
        $('#wrong').text(wrong);
        $('#progress').text(`${currentQuizIndex + 1}/${quizzes.length}`);
    }

    function loadRankings() {
    $.get('api/get-rankings.php', function(res) {
        if (res.success && res.data.length > 0) {
            let html = '<ul class="rank-list" style="list-style: none; padding: 0;">';
            res.data.forEach((user, index) => {
                // å®šä¹‰å‰ä¸‰åç§°å·
                const titles = ['ğŸ†ğŸ† å† å†›', 'ğŸ¥ˆğŸ¥ˆ äºšå†›', 'ğŸ¥‰ğŸ¥‰ å­£å†›'];
                const title = index < 3 ? titles[index] : '';
                
                html += `<li class="rank-item ${index < 3 ? 'top-rank' : ''}" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <span class="rank" style="width: 30px; text-align: center; font-weight: bold;">${index + 1}</span>
                    <span class="username" style="flex: 1; margin: 0 10px;">${user.username} ${title}</span>
                    <span class="points" style="color: #e91e63; font-weight: bold;">${user.points} ç§¯åˆ†</span>
                </li>`;
            });
            html += '</ul>';
            $('#rankingsList').html(html);
            
            // æ’è¡Œæ¦œæ ·å¼ä¿æŒä¸å˜
            const style = document.createElement('style');
            style.textContent = `
                .rank-item.top-rank:nth-child(1) { background-color: #fff8e1; }
                .rank-item.top-rank:nth-child(2) { background-color: #f5f5f5; }
                .rank-item.top-rank:nth-child(3) { background-color: #fff3e0; }
            `;
            document.head.appendChild(style);
        } else {
            $('#rankingsList').html('<p style="text-align: center; color: var(--muted);">æš‚æ— æ’åæ•°æ®</p>');
        }
    }).fail(function() {
        $('#rankingsList').html('<p style="text-align: center; color: var(--muted);">æ’è¡Œæ¦œåŠ è½½å¤±è´¥</p>');
    });
}

$(document).ready(function() {
    // åŠ è½½æ’è¡Œæ¦œï¼ˆæ— éœ€ç™»å½•ï¼‰
    loadRankings();
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    $.get('api/check-login.php', function(res) {
        if (!res.logged_in) {
            $('#quiz').html('<div style="text-align: center; padding: 40px;"><i class="fas fa-exclamation-circle" style="color: var(--brand); font-size: 24px;"></i><p style="margin-top: 15px;">è¯·å…ˆç™»å½•å†å‚ä¸ç­”é¢˜</p><button class="btn" onclick="window.location.href=\'login.html\'" style="margin-top: 10px;">å»ç™»å½•</button></div>');
            return;
        }
        loadQuiz();
    });

    // é€€å‡ºç™»å½•åŠŸèƒ½
    $('#logoutBtn').click(function() {
        $.get('api/logout.php', function() {
            window.location.href = 'login.html';
        });
    });
});
</script>

</body>
</html>